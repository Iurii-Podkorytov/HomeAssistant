## 2. Install ESPHome Add-on to Home Assistant

ESPHome is a fantastic tool for creating custom firmware for ESP-based devices, integrated seamlessly with Home Assistant.

1.  **Access Home Assistant:** Log in to your Home Assistant instance through your web browser.
2.  Go to **Settings** > **Add-ons**.
3.  Click on the **"Add-on Store"** in the bottom right corner.
4.  Search for **"ESPHome."**
5.  Click on the ESPHome add-on and then click **"Install."**
6.  The installation may take a few moments. Once complete, click **"Start"** and then **"Open Web UI."**
7.  The ESPHome dashboard will open in a new tab. You might be asked to authenticate with your Home Assistant credentials.

> **Space for Picture:** Home Assistant Add-on Store screenshot
> **Space for Picture:** ESPHome add-on installation screenshot
> **Space for Picture:** ESPHome dashboard screenshot

## 3. Install Basic Blink LED Firmware

This section focuses on the *first* installation using a USB cable. Subsequent updates can be done wirelessly (Over-The-Air, OTA).

### 3.1 Create a New ESPHome Device

1.  In the ESPHome dashboard, click the **"+ New Device"** button (or similar).
2.  Follow the wizard to give your device a name (e.g., `my_blink_led`), choose the correct board type (e.g., ESP32 Dev Module, ESP8266, etc.), and enter your Wi-Fi credentials (SSID and password). These credentials are vital for future wireless updates.

    > **Space for Picture:** ESPHome "New Device" wizard screenshots

### 3.2 Add Basic Blink LED Firmware Configuration

After creating the device, ESPHome will generate a basic YAML configuration file. You'll need to modify this to make an LED blink.

1.  On the ESPHome dashboard, find your newly created device and click **"Edit"** (the pencil icon).
2.  Add the following code to the end of the `.yaml` file. This example assumes an onboard LED on GPIO13 (common for some ESP boards) or an external LED connected to GPIO13. If your board's onboard LED is on a different GPIO (e.g., GPIO2 for ESP8266 D1 Mini, GPIO5 for ESP32-S3 DevKitC-1-N8R2, GPIO3 for ESP32-C3-DevKitM-1), adjust the `pin: number:` accordingly.

    ```yaml
    # Example configuration entry for a blinking LED on GPIO13
    output:
      - platform: gpio
        pin:
          number: D13 # Or the actual GPIO pin number like 13 if it's an ESP32
          mode: output
        id: onboard_led

    light:
      - platform: binary
        name: "My Blink LED"
        output: onboard_led
    
    # This interval will toggle the LED every 500ms (0.5 seconds)
    interval:
      - interval: 500ms
        then:
          - light.toggle: my_blink_led
    ```
    *   **Explanation:**
        *   `output`: Defines an output component.
        *   `platform: gpio`: Specifies that it's a GPIO pin.
        *   `pin: number: D13`: Sets the pin to D13 (replace with your board's actual GPIO pin).
        *   `mode: output`: Configures the pin as an output.
        *   `id: onboard_led`: Gives this output a unique ID to reference it.
        *   `light`: Defines a light component.
        *   `platform: binary`: Creates a simple on/off light.
        *   `name: "My Blink LED"`: The name that will appear in Home Assistant.
        *   `output: onboard_led`: Links this light to the `onboard_led` output.
        *   `interval`: Creates a recurring action.
        *   `interval: 500ms`: The action will occur every 500 milliseconds.
        *   `then: - light.toggle: my_blink_led`: Toggles the state of the "My Blink LED" light.

3.  Click **"Save"** in the ESPHome editor.
4.  Click **"Validate"** to check for any syntax errors.

    > **Space for Picture:** ESPHome YAML editor with blink code screenshot

### 3.3 Initial Installation with Cable (USB Flashing)

For the very first firmware installation, you'll need to connect your ESP device to the computer running VirtualBox (your host machine) via a USB cable. Ensure your USB cable supports data transfer, not just power.

1.  **Connect your ESP device:** Plug your ESP board into a USB port on your host machine.
2.  **Enable USB Passthrough (VirtualBox Setting):**
    *   In VirtualBox Manager, make sure your Home Assistant VM is powered **off**.
    *   Go to your Home Assistant VM's **"Settings"** > **"USB."**
    *   Check **"Enable USB Controller"** and select **"USB 3.0 (xHCI) Controller."**
    *   Click the **"+"** icon to add a new USB filter. Select your ESP device from the list (it might appear as "USB to UART Bridge Controller" or something similar). This ensures the VM can access the USB device.
    *   Click **"OK."**

    > **Space for Picture:** VirtualBox USB settings screenshot

3.  **Start your Home Assistant VM.**
4.  **In ESPHome Dashboard:**
    *   Click the **"Install"** button next to your device's configuration.
    *   Choose the option **"Plug into the computer running ESPHome Dashboard"** (or similar, indicating USB).
    *   A pop-up will appear asking you to connect to a device. Select the USB port corresponding to your ESP device (e.g., "USB to UART Bridge Controller").
    *   Click **"Connect."**
    *   **Crucially, while the installation prepares, you may need to press and hold the "BOOT" button on your ESP board (if it has one) until the installation begins, then release it.** This varies by board.
    *   ESPHome will compile and upload the firmware. This process can take a few minutes, especially the first time, as it downloads dependencies.

    > **Space for Picture:** ESPHome Install options screenshot
    > **Space for Picture:** ESPHome USB device selection pop-up screenshot
    > **Space for Picture:** ESPHome flashing progress screenshot

5.  **Verify Installation:**
    *   Once the installation is complete, your ESP device should reboot, and the LED connected to GPIO13 should start blinking.
    *   In the ESPHome dashboard, your device's status should change to "Online."
    *   You can also view the logs in the ESPHome dashboard by clicking "LOGS" next to your device to see if it's connecting to Wi-Fi and running as expected.

### 3.4 Subsequent Installations (Wirelessly/OTA)

Once the initial firmware is flashed with Wi-Fi credentials, all future updates can be done wirelessly (Over-The-Air or OTA).

1.  **Make changes to your YAML configuration** in the ESPHome dashboard.
2.  Click **"Install"** next to your device.
3.  This time, choose the option **"Wirelessly"** or **"Update via Network."** ESPHome will compile the new firmware and push it to your device over Wi-Fi.

    > **Space for Picture:** ESPHome Wireless update option screenshot

Congratulations! You have successfully set up Home Assistant on a VirtualBox VM, installed the ESPHome add-on, and flashed a basic blink LED firmware to your ESP device.